<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>CAFFY - Checkout</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="../css/normalize.css">
  <link rel="stylesheet" href="../css/skeleton.css">
  <link rel="stylesheet" href="../css/style.css">
  <link rel="icon" type="image/png" href="../images/favicon.ico">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preload"
    href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&family=Ubuntu+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap"
    as="style" onload="this.onload=null;this.rel='stylesheet'" />
  <noscript>
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&family=Ubuntu+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap"
      rel="stylesheet" type="text/css" />
  </noscript>
  
  <!-- Umami Analytics -->
  <script defer src="https://analytics.getcaffy.com/script.js" data-website-id="9ff81ca6-c20a-4e0e-a512-17fc4d51f211"></script>

  <script src="https://js.stripe.com/v3/"></script>
  <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/4.0.0/model-viewer.min.js"></script>
  <script src="https://kit.fontawesome.com/ab45b5ded8.js" crossorigin="anonymous"></script>
  <style>
    /* All previous, correct CSS is included here */
:not(:defined)>* {
  display: none;
}

.product-model {
  width: 100%;
  height: 50vh;
  margin: 0 auto;
  cursor: grab;
}

.hidden {
  display: none !important;
}

.cart-icon-container {
  position: fixed;
  bottom: 20px;
  right: 20px;
  cursor: pointer;
  z-index: 1001;
  filter: drop-shadow(0 0 5px #00ffff);
  transition: opacity 0.3s, transform 0.3s;
}

.cart-icon-container i {
  color: #00ffff;
}

#cart-count {
  position: absolute;
  top: -8px;
  right: -8px;
  background: #00ffff;
  color: #000;
  border-radius: 50%;
  padding: 2px 8px;
  font-size: 14px;
  font-weight: bold;
}

#footerButtonContainer {
  position: fixed;
  bottom: 20px;
  left: 20px;
  z-index: 1001;
  background: none;
  border: none;
  cursor: pointer;
  transition: opacity 0.3s, transform 0.3s;
}

#footerButtonContainer i {
  color: #888;
  font-size: 32px;
}

body.checkout-active .cart-icon-container,
body.checkout-active #footerButtonContainer,
body.cart-open .cart-icon-container {
  opacity: 0;
  pointer-events: none;
  transform: scale(0.8);
}

.cart-modal {
  box-sizing: border-box;
  position: fixed;
  top: 0;
  right: 0;
  width: 100%;
  max-width: 420px;
  height: 100%;
  background: #121212;
  color: #fff;
  border-left: 1px solid #00ffff;
  box-shadow: -5px 0 25px rgba(0, 255, 255, 0.2);
  z-index: 1002;
  transform: translateX(100%);
  transition: transform 0.3s ease-in-out;
  display: flex;
  flex-direction: column;
  font-family: 'Montserrat', sans-serif;
}

.cart-modal.open {
  transform: translateX(0);
}

.cart-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-shrink: 0;
  padding: 25px;
  font-size: 24px;
  font-weight: 500;
  margin: 0;
  border-bottom: 1px solid #333;
}

.close-cart-btn {
  background: none;
  border: none;
  color: #888;
  font-size: 28px;
  cursor: pointer;
  line-height: 1;
  padding: 0;
}

.cart-items {
  flex-grow: 1;
  overflow-y: auto;
  padding: 10px 25px;
}

.cart-item {
  display: flex;
  align-items: center;
  padding: 15px 0;
  border-bottom: 1px solid #222;
}

.cart-item-model {
  width: 70px;
  height: 70px;
  min-width: 70px;
  margin-right: 15px;
  border-radius: 4px;
}

.cart-item-details {
  flex-grow: 1;
}

.cart-item-details h5 {
  margin: 0;
  font-size: 16px;
}

.cart-item-details p {
  margin: 5px 0 0;
  color: #888;
}

.cart-item-actions {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-left: 15px;
}

.quantity-controls {
  display: flex;
  align-items: center;
  margin-bottom: 5px;
}

.quantity-controls button {
  background: #222;
  color: #fff;
  border: 1px solid #444;
  width: 28px;
  height: 28px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  line-height: 1;
  font-size: 18px;
}

.quantity-controls span {
  min-width: 30px;
  text-align: center;
}

.remove-item-btn {
  background: none;
  border: none;
  color: #ff5a5f;
  cursor: pointer;
  font-size: 12px;
  font-weight: bold;
}

.cart-empty-message {
  color: #888;
  text-align: center;
  margin-top: 50px;
}

.cart-footer {
  flex-shrink: 0;
  padding: 25px;
  border-top: 1px solid #333;
}

.cart-total {
  display: flex;
  justify-content: space-between;
  font-size: 18px;
  font-weight: 500;
  margin-bottom: 20px;
}

#checkout-button {
  width: 100%;
  background-color: #00ffff;
  color: #000;
  border-color: #00ffff;
  font-weight: bold;
}

#checkout-view {
  color: #fff;
  padding-bottom: 100px;
}

#back-to-store-button {
  position: relative;
  z-index: 10;
  display: flex;
  align-items: center;
  width: fit-content;
  margin: 40px auto 20px;
  background: none;
  border: 1px solid #444;
  color: #aaa;
  padding: 10px 20px;
  cursor: pointer;
  font-family: 'Montserrat', sans-serif;
  font-weight: 500;
  border-radius: 4px;
}

#payment-form {
  margin: 40px auto;
  max-width: 500px;
  padding: 0 15px;
}

.form-section {
  margin-bottom: 35px;
}

.form-section h4 {
  margin-bottom: 20px;
  font-weight: 500;
  color: #00ffff;
  border-bottom: 1px solid #333;
  padding-bottom: 10px;
}

.form-row {
  display: flex;
  gap: 15px;
  margin-bottom: 20px;
}

.form-field {
  flex: 1;
}

.form-field label {
  display: block;
  margin-bottom: 8px;
  color: #ccc;
  font-size: 14px;
  font-weight: 500;
}

.form-field input[type="email"],
.form-field input[type="tel"],
.form-field input[type="text"] {
  width: 100%;
  padding: 12px 15px;
  background: #1a1a1a;
  border: 1px solid #444;
  border-radius: 4px;
  color: #fff;
  font-family: 'Montserrat', sans-serif;
  font-size: 14px;
  box-sizing: border-box;
}

.form-field input:focus {
  outline: none;
  border-color: #00ffff;
  box-shadow: 0 0 0 2px rgba(0, 255, 255, 0.2);
}

.form-field input::placeholder {
  color: #666;
}

.required {
  color: #ff5a5f;
}

#address-element,
#payment-element {
  margin-bottom: 24px;
}

.checkbox-field {
  display: flex;
  align-items: flex-start;
  margin: 20px 0;
  gap: 12px;
}

.checkbox-field input[type="checkbox"] {
  margin: 0;
  width: 18px;
  height: 18px;
  accent-color: #00ffff;
  flex-shrink: 0;
  margin-top: 2px;
}

.checkbox-field label {
  color: #aaa;
  font-size: 14px;
  line-height: 1.4;
  cursor: pointer;
}

.checkbox-field label a {
  color: #00ffff;
  text-decoration: none;
}

.checkbox-field label a:hover {
  text-decoration: underline;
}

.order-summary {
  background: #1a1a1a;
  border: 1px solid #333;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 30px;
}

.order-summary h4 {
  margin-top: 0;
  margin-bottom: 15px;
  color: #00ffff;
}

.order-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 0;
  border-bottom: 1px solid #2a2a2a;
}

.order-item:last-child {
  border-bottom: none;
  padding-bottom: 0;
  margin-top: 10px;
  font-weight: 600;
  color: #00ffff;
}

.order-item-name {
  color: #ccc;
}

.order-item-price {
  color: #fff;
}

#submit-payment-button {
  width: 100%;
  background-color: #00ffff;
  color: #000;
  border-color: #00ffff;
  font-weight: bold;
  padding: 15px;
  font-size: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
}

#submit-payment-button:disabled {
  background-color: #555;
  cursor: not-allowed;
}

#payment-message {
  color: #ff5a5f;
  text-align: center;
  margin-top: 20px;
}

#footer {
  width: 100%;
  position: fixed;
  left: 0;
  bottom: 0;
  z-index: 1000;
  background-color: #1a1a1a;
  padding: 20px 0;
  border-top: 1px solid #00ffff;
  box-shadow: 0 -5px 25px rgba(0, 255, 255, 0.2);
}

.footer-content {
  width: 80%;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 15px;
}

.social-icons {
  display: flex;
  justify-content: center;
  gap: 40px;
}

.social-icons a {
  color: #ccc;
  font-size: 24px;
}

.links a {
  color: #aaa;
}

.trademark {
  color: #666;
  font-size: 0.9rem;
}

/* --- SYSTEM DECRYPT (Clean & Subtle) --- */
.cyber-reveal {
  font-family: 'Ubuntu Mono', monospace !important;
  color: #00ffff !important;
  font-weight: 400 !important;
  letter-spacing: 3px;
  text-transform: uppercase;
  text-shadow: 0 0 8px rgba(0, 255, 255, 0.4);
  display: block; 
  width: 100%;
  text-align: center;
  animation: system-boot 0.6s cubic-bezier(0.22, 1, 0.36, 1) forwards;
}

.deal-text {
  font-family: 'Ubuntu Mono', monospace;
  font-size: 1.5rem;
  color: #888;
  margin-top: 8px;
  opacity: 0;
  letter-spacing: 1px;
  transition: opacity 0.5s ease 0.2s;
}

.deal-text.visible {
  opacity: 1;
}

.accent-cyan {
  color: #00ffff;
  font-weight: 700;
}

@keyframes system-boot {
  0% {
    opacity: 0;
    color: #ffffff;
    text-shadow: 0 0 20px #ffffff;
    transform: scale(0.98);
  }
  10% {
    opacity: 1;
    color: #ffffff;
  }
  100% {
    color: #00ffff;
    text-shadow: 0 0 8px rgba(0, 255, 255, 0.4);
    transform: scale(1);
  }
}

/* --- MARQUEE --- */
.marquee-wrapper {
  width: 100%;
  background: #000;
  border-bottom: 1px solid #1a1a1a;
  overflow: hidden;
  white-space: nowrap;
  height: 25px;
  display: flex;
  align-items: center;
  position: relative;
  z-index: 5;
}

.marquee-text {
  display: inline-block;
  padding-left: 100%;
  animation: scroll-left 15s linear infinite;
  font-family: 'Ubuntu Mono', monospace;
  font-size: 11px;
  color: #00ffff;
  text-transform: uppercase;
  letter-spacing: 2px;
}

@keyframes scroll-left {
  0% { transform: translateX(0); }
  100% { transform: translateX(-100%); }
}

/* Add this inside your <style> block */
.no-transition {
  transition: none !important;
}

/* --- QUANTITY CONTROLS (Cyber-Pill) --- */
.quantity-pill {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: #111;
  border: 1px solid #333;
  border-radius: 20px;
  height: 32px;
  width: 100px;
  overflow: hidden;
  margin-bottom: 5px;
}

.qty-btn {
  background: transparent;
  border: none;
  color: #fff;
  width: 30px;
  height: 100%;
  font-size: 14px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.2s;
  padding: 0;
  margin: 0;
}

.qty-btn:hover { 
  background: rgba(0, 255, 255, 0.1); 
  color: #00ffff; 
}

.qty-btn:active { 
  background: rgba(0, 255, 255, 0.2); 
}

.qty-val {
  font-family: 'Ubuntu Mono', monospace;
  font-size: 14px;
  color: #00ffff;
  width: 20px;
  text-align: center;
  border-left: 1px solid #222;
  border-right: 1px solid #222;
  line-height: 30px;
}

/* --- CROSS SELL & DISCOUNT NOTES --- */
.cross-sell-box {
  background: rgba(0, 255, 255, 0.05);
  border: 1px dashed #333;
  border-radius: 8px;
  padding: 10px;
  margin-top: 15px;
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.cross-sell-text { 
  font-size: 12px; 
  color: #ccc; 
  text-transform: uppercase;
  letter-spacing: 1px;
  margin: 0;
}

.cross-sell-btn {
  background: transparent;
  border: 1px solid #00ffff;
  color: #00ffff;
  font-size: 10px;
  padding: 5px 15px;
  border-radius: 15px;
  cursor: pointer;
  text-transform: uppercase;
  letter-spacing: 1px;
  transition: all 0.2s;
  margin: 0;
  height: auto;
  line-height: 1;
}

.cross-sell-btn:hover {
  background: #00ffff;
  color: #000;
}

.discount-note {
  font-family: 'Ubuntu Mono', monospace;
  font-size: 12px;
  color: #00ffff;
  text-align: right;
  margin-bottom: 5px;
  margin-top: 20px;
  opacity: 0.8;
  letter-spacing: 0.5px;
}

/* --- MOBILE OPTIMIZATIONS (Locked Viewport) --- */
    @media (max-width: 768px) {
      /* 1. LOCK SCREEN */
      html, body {
        height: 100dvh;
        width: 100vw;
        overflow: hidden;
        margin: 0; padding: 0;
        position: fixed;
      }

      #main-content {
        height: 100dvh;
        width: 100%;
        display: flex;
        flex-direction: column;
      }

      /* 2. HEADER - Tighter (8%) */
      /* Pulled up from 10% to create room */
      #HeroContainer {
        flex: 0 0 auto;
        height: auto !important;
        padding: 5px 0 0 0 !important;
        margin: 0 !important;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2;
        width: 100%;
      }
      
      #HeroContainer .columns { margin: 0 !important; width: 100%; text-align: center; }
      
      #title { 
        font-size: 2.8rem; 
        line-height: 1; 
        margin: 0; 
        width: 100%; text-align: center; 
      }
      
      #subtitle { display: none; }

      /* 3. MARQUEE */
      .marquee-wrapper {
        flex: 0 0 auto;
        height: 30px !important;
        width: 100%;
        display: flex !important;
        align-items: center;
        background: #000;
        border-bottom: 1px solid #1a1a1a;
        z-index: 5;
      }
      
      .marquee-text {
        font-size: 10px;
        padding-top: 2px;
      }
      
      /* 4. PRODUCT CONTAINER */
      #main-content > .container:last-of-type {
        flex: 1;
        height: auto !important;
        width: 100%;
        max-width: 100%;
        margin: 0 !important;
        padding: 0 !important;
        display: flex;
        flex-direction: column;
        overflow: hidden; 
      }

      .row {
        height: 100%;
        width: 100%;
        margin: 0 !important;
        display: flex;
        flex-direction: column;
      }

      /* 5. PRODUCT SPLIT (Lifted) */
      .six.columns {
        flex: 1; 
        width: 100% !important;
        margin: 0 !important;
        display: flex;
        flex-direction: column;
        
        /* This centers items vertically... */
        justify-content: center; 
        align-items: center;
        
        /* ...BUT this padding pushes the "Center" upwards */
        padding-bottom: 6vh !important; 
        
        position: relative;
        border-bottom: 1px solid #11111100;
        overflow: hidden;
      }

      .six.columns:last-child { border-bottom: none; }

      /* 6. 3D MODEL */
      .product-model {
        flex: 1; 
        width: 90%;
        min-height: 0;
        max-height: 100%;
        margin: 0 auto !important;
        display: block;
      }

      /* 7. TEXT (The -10 Trick) */
      h4.product {
        font-size: 2rem;
        /* Negative margin sucks the text up to the model */
        margin: -15px 0 10px 0 !important; 
        line-height: 1;
        flex-shrink: 0;
        position: relative; 
        z-index: 5; /* Ensure text sits on top of model bounding box */
      }

      p.price {
        font-size: 1.5rem;
        margin: 0 0 10px 0;
        color: #ccc;
        line-height: 1;
        flex-shrink: 0;
      }

      /* 8. BUTTONS */
      button.add-to-cart-button.columns {
        width: auto !important;
        min-width: 140px !important;
        max-width: 180px !important;
        flex: 0 0 auto;
        align-self: center !important;
        margin: 0 !important;
        height: 36px !important;
        line-height: 34px !important;
        padding: 0 25px !important;
        font-size: 10px !important;
        letter-spacing: 2px;
        display: inline-block !important;
      }

      /* 9. ICONS */
      .cart-icon-container {
        position: fixed !important;
        bottom: 20px !important;
        right: 20px !important;
        z-index: 99999 !important;
      }

      #footerButtonContainer {
        position: fixed !important;
        bottom: 20px !important;
        left: 20px !important;
        z-index: 1 !important;
        
        /* Reset all button defaults that cause offsets */
        margin: 0 !important;
        padding: 0 !important;
        border: none !important;
        background: transparent !important;
        width: auto !important;
        height: auto !important;
        
        /* Center the icon */
        display: flex !important;
        align-items: center;
        justify-content: center;
      }

      /* 10. FOOTER ICONS - Aggressive Shrink */
      .social-icons {
        gap: 20px !important; /* Pull them closer together */
        margin-bottom: 5px !important;
      }

      .social-icons a i {
        font-size: 1.5rem !important; /* Override the 'fa-xl' class */
        color: #888 !important; /* Dim them slightly so they aren't so loud */
      }

      /* --- CRITICAL: UNLOCK SCROLL FOR CHECKOUT --- */
      body.checkout-active {
        overflow-y: auto !important; /* Allow vertical scroll */
        position: static !important; /* Release the 'fixed' lock */
        height: auto !important;     /* Allow body to grow */
      }

      /* --- FIXED CHECKOUT SCROLLING --- */
      /* This forces the checkout view to handle its own scrolling, 
         ignoring the locked body/html behind it. */
      #checkout-view {
        position: fixed !important;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100dvh !important; /* Take full screen */
        
        overflow-y: scroll !important; /* Force internal scroll */
        -webkit-overflow-scrolling: touch; /* Smooth iOS scroll */
        
        z-index: 9999999 !important; /* Sit on top of everything */
        background: #121212; /* Ensure background is solid */
        
        padding: 20px 20px 150px 20px !important; /* Extra bottom padding for keyboard */
        box-sizing: border-box;
      }
    }
  </style>
</head>



<body>

  <div class="marquee-wrapper">
          <div class="marquee-container">
            <div class="marquee-text">Welcome to the future - you belong here. // 20% OFF LAUNCH DISCOUNT // LIMITED TIME OFFER // FREE SHIPPING </div>
          </div>
        </div>

  <div id="main-content">
    <div class="container" id="HeroContainer">
      <div class="hero twelve columns">
        <div id="title" class="montserrat-500">CAFFY</div>
        <h5 id="subtitle" class="montserrat-300">Welcome to the future - you belong here.</h5>
      </div>
    </div>

    <div class="container">
      <div class="row">
        <!-- COOL MINT -->
        <div class="six columns u-text-center">
          <model-viewer class="product-model" src="../CaffyPouchMintMVout6b.glb"
            variant-name="Mint" loading="eager" camera-orbit="0deg 55deg" interaction-prompt="none" auto-rotate camera-controls disable-pan shadow-intensity="0"
            alt="3D model of Caffy Pouch - Cool Mint"></model-viewer>
          <h4 class="product">Cool Mint</h4>
          
          <!-- ID ADDED HERE for Live Updates -->
          <p class="price" id="price-text-mint">Loading...</p>
          
          <!-- DATA-ID UPDATED HERE -->
          <button class="button-primary add-to-cart-button six columns offset-by-three"
            data-id="price_1QrjjHFAY8BwNpdGLqU1zwtO" 
            data-name="Caffy Pouch - Cool Mint" 
            data-price="0"
            data-image="../images/caffy-pouch-mint.png" 
            data-model="../CaffyPouchMintMVout6b.glb"
            data-variant="Mint"
            data-umami-event="Add to Cart"
            data-umami-event-product="Cool Mint"
            >Add to Cart</button>
        </div>

        <!-- BLUEBERRY -->
        <div class="six columns u-text-center">
          <model-viewer class="product-model" src="../CaffyPouchMintMVout6b.glb"
            variant-name="Blueberry" loading="eager" camera-orbit="180deg 55deg" interaction-prompt="none" auto-rotate camera-controls disable-pan shadow-intensity="0"
            alt="3D model of Caffy Pouch - Blueberry"></model-viewer>
          <h4 class="product">Blueberry</h4>
          
          <!-- ID ADDED HERE for Live Updates -->
          <p class="price" id="price-text-blueberry">Loading...</p>
          
          <!-- DATA-ID UPDATED HERE -->
          <button class="button-blueberry add-to-cart-button six columns offset-by-three"
            data-id="price_1QrjbYFAY8BwNpdG1KvCMlKz" 
            data-name="Caffy Pouch - Blueberry" 
            data-price="0"
            data-image="../images/caffy-pouch-blueberry.png" 
            data-model="../CaffyPouchMintMVout6b.glb"
            data-variant="Blueberry"
            data-umami-event="Add to Cart"
            data-umami-event-product="Blueberry"
            >Add to Cart</button>
        </div>
      </div>
    </div>
  </div>

  <div id="checkout-view" class="hidden">
    <button id="back-to-store-button"
      data-umami-event="Abandon Checkout" 
      data-umami-event-reason="Clicked Back"
    >← Back to Store</button>
    
    <form id="payment-form">
      <!-- Order Summary -->
      <div class="order-summary">
        <h4>Order Summary</h4>
        <div id="order-items-list">
          <!-- Order items will be populated here -->
        </div>
      </div>

      <!-- Contact Information -->
      <div class="form-section">
        <h4>Contact Information</h4>
        <div class="form-field">
          <label for="customer-email">Email Address <span class="required">*</span></label>
          <input type="email" id="customer-email" name="email" required placeholder="your@email.com">
        </div>
      </div>

      <!-- Shipping Address -->
      <div class="form-section">
        <h4>Shipping Address</h4>
        <div id="address-element">
          <!-- Stripe Address Element will be inserted here -->
        </div>
      </div>

      <!-- Payment Details -->
      <div class="form-section">
        <h4>Payment Details</h4>
        <div id="payment-element">
          <!-- Stripe Payment Element will be inserted here -->
        </div>
      </div>

      <!-- Marketing and Terms -->
      <div class="form-section">
        <div class="checkbox-field">
          <input id="marketing-checkbox" type="checkbox" name="marketing"/>
          <label for="marketing-checkbox">
            I would like to receive news, special offers, and product updates from CAFFY.
          </label>
        </div>
        
        <div class="checkbox-field">
          <input id="terms-checkbox" type="checkbox" name="terms" required />
          <label for="terms-checkbox">
            I agree to the <a href="/terms" target="_blank">Terms of Service</a> and <a href="/privacy" target="_blank">Privacy Policy</a> <span class="required">*</span>
          </label>
        </div>
      </div>

      <button id="submit-payment-button" class="button-primary">
        <span id="button-text">Pay now</span>
      </button>
      <div id="payment-message" class="hidden"></div>
    </form>
  </div>

  <div class="cart-icon-container" id="cart-icon"><i class="fas fa-shopping-cart fa-2x"></i><span
      id="cart-count">0</span></div>
  <button id="footerButtonContainer"><i class="fas fa-info-circle"></i></button>

  <div id="footer" style="display: none;">
    <div class="footer-content">
      <div class="social-icons"><a href="https://x.com/GetCaffy" title="Twitter"><i
            class="fa-xl fab fa-twitter"></i></a><a href="https://www.instagram.com/get__caffy/" title="Instagram"><i
            class="fa-xl fab fa-instagram"></i></a><a href="https://www.tiktok.com/@getcaffy" title="TikTok"><i
            class="fa-xl fab fa-tiktok"></i></a><a href="https://www.linkedin.com/company/getcaffy/" title="LinkedIn"><i
            class="fa-xl fab fa-linkedin"></i></a><a href="https://www.reddit.com/user/getcaffy/" title="Reddit"><i
            class="fa-xl fab fa-reddit"></i></a><a href="https://www.youtube.com/@GetCaffy" title="YouTube"><i
            class="fa-xl fab fa-youtube"></i></a></div>
      <div class="links"><a href="/terms" class="montserrat-300">Terms</a><a href="/faq"
          class="montserrat-300">FAQ</a><a href="/privacy" class="montserrat-300">Privacy</a></div>
      <div class="trademark">© 2024 CAFFY Ltd. All rights reserved.</div>
    </div>
  </div>

  <div class="cart-modal" id="cart-modal">
    <div class="cart-header"><span>Your Basket</span><button class="close-cart-btn">&times;</button></div>
    <div class="cart-items" id="cart-items-container"></div>
    <div class="cart-footer">
      <div class="cart-total"><span>Total</span><span id="cart-total">0.00 AED</span></div>
      <button class="button-primary" id="checkout-button"
        data-umami-event="Begin Checkout"
        data-umami-event-location="Cart Modal"
      >Proceed to Checkout</button>
    </div>
  </div>

  <script type="text/javascript">
    // --- ACTION ITEM: Your real publishable key goes here ---
    const stripe = Stripe('pk_live_51QYtamFAY8BwNpdGTgOgr38QJD7IJ6YHwzWW8kJ3gEfDXjMkNQov2VvhgTBb5kbxHxrtAHaVSl0P2kCBXXmwqBKO00MBg79AMV');

    // --- HELPER: GET UMAMI SESSION SAFELY ---
    async function getUmamiId() {
      try {
        // 1. Try localStorage (Usually the most reliable)
        const storage = localStorage.getItem('umami.session');
        if (storage) {
          const parsed = JSON.parse(storage);
          if (parsed && parsed.id) return parsed.id;
        }
        // 2. Try the function fallback
        if (window.umami && typeof window.umami.getSessionId === 'function') {
          const id = window.umami.getSessionId();
          if (id) return id;
        }
      } catch (e) {
        console.warn("Umami ID fetch failed", e);
      }
      return "anonymous_or_blocked";
    }

    // --- STRIPE ELEMENTS LOGIC ---
    let elements;
    let addressElement;
    let paymentElement;

    // --- CART STATE & DOM ELEMENTS ---
    let cart = JSON.parse(localStorage.getItem('caffy_cart') || '[]');
    let activeDiscountRules = []; // Store rules from backend
    const mainContent = document.getElementById('main-content');
    const checkoutView = document.getElementById('checkout-view');
    const backToStoreButton = document.getElementById('back-to-store-button');
    const cartIcon = document.getElementById('cart-icon');
    const cartModal = document.getElementById('cart-modal');
    const cartItemsContainer = document.getElementById('cart-items-container');
    const cartCount = document.getElementById('cart-count');
    const cartTotal = document.getElementById('cart-total');
    const checkoutButton = document.getElementById('checkout-button');
    const closeCartButton = document.querySelector('.close-cart-btn');
    const footer = document.getElementById('footer');
    const footerButton = document.getElementById('footerButtonContainer');

    function calculateFinalTotal() {
      let subtotal = cart.reduce((t, i) => t + i.price * i.quantity, 0);
      let totalQty = cart.reduce((t, i) => t + i.quantity, 0);
      let discountAmount = 0;
      let discountLabel = "";

      // Use the rules fetched from the Worker's /get-prices endpoint
      if (activeDiscountRules && activeDiscountRules.length > 0) {
        const sortedRules = activeDiscountRules.sort((a, b) => b.threshold - a.threshold);
        const activeRule = sortedRules.find(rule => totalQty >= rule.threshold);

        if (activeRule) {
          discountAmount = subtotal * (activeRule.percent / 100);
          discountLabel = activeRule.label;
        }
      }

      return {
        subtotal: subtotal,
        discountAmount: discountAmount,
        discountLabel: discountLabel,
        finalTotal: subtotal - discountAmount
      };
    }

    // --- CART FUNCTIONS ---
    function updateCart(itemId, newQuantity) {
      const item = cart.find(i => i.id === itemId);
      if (item) {
        item.quantity = newQuantity;
        if (item.quantity <= 0) cart = cart.filter(i => i.id !== itemId);
      }
      saveCart(); 
      updateCartDisplay();
    }

    function addToCart(item) {
      const existingItem = cart.find(cartItem => cartItem.id === item.id);
      if (existingItem) existingItem.quantity++;
      else cart.push({ ...item, quantity: 1 });
      
      saveCart(); // <--- ADD THIS
      updateCartDisplay();
    }

    function updateCartDisplay() {
      const container = document.getElementById('cart-items-container');
      
      if (cart.length === 0) {
        container.innerHTML = '<p class="cart-empty-message">Your basket is empty.</p>';
        document.getElementById('checkout-button').disabled = true;
        document.getElementById('cart-count').textContent = '0';
        document.getElementById('cart-total').textContent = '0.00 AED';
        return;
      }

      let total = 0;
      let count = 0;
      let hasMint = false;
      let hasBerry = false;

      container.innerHTML = '';

      cart.forEach(item => {
        total += item.price * item.quantity;
        count += item.quantity;
        
        // --- FIX: Check the Variant Name, not the random ID ---
        if (item.variant === "Mint") hasMint = true;
        if (item.variant === "Blueberry") hasBerry = true;

        const itemEl = document.createElement('div');
        itemEl.classList.add('cart-item');
        
        itemEl.innerHTML = `
          <model-viewer class="cart-item-model" src="${item.model}" variant-name="${item.variant}" disable-zoom disable-pan shadow-intensity="0"></model-viewer>
          <div class="cart-item-details">
            <h5>${item.name}</h5>
            <p>${(item.price / 100).toFixed(2)} AED</p>
          </div>
          <div class="cart-item-actions">
            <div class="quantity-pill">
              <button class="qty-btn" onclick="updateCart('${item.id}', ${item.quantity - 1})">−</button>
              <span class="qty-val">${item.quantity}</span>
              <button class="qty-btn" onclick="updateCart('${item.id}', ${item.quantity + 1})">+</button>
            </div>
            <button class="remove-item-btn" onclick="updateCart('${item.id}', 0)">REMOVE</button>
          </div>
        `;
        container.appendChild(itemEl);
      });

      // --- CROSS SELL LOGIC ---
      if (hasMint && !hasBerry) {
        const crossSellDiv = document.createElement('div');
        crossSellDiv.className = 'cross-sell-box';
        crossSellDiv.innerHTML = `
            <div class="cross-sell-text">Flavor check: Try Blueberry?</div>
            <button class="cross-sell-btn" id="cross-add-berry">Add +1</button>
        `;
        container.appendChild(crossSellDiv);
        
        setTimeout(() => {
            document.getElementById('cross-add-berry').addEventListener('click', () => {
                const btn = document.querySelector('button[data-variant="Blueberry"]');
                if(btn) btn.click(); 
            });
        }, 0);
      } 
      else if (hasBerry && !hasMint) {
        const crossSellDiv = document.createElement('div');
        crossSellDiv.className = 'cross-sell-box';
        crossSellDiv.innerHTML = `
            <div class="cross-sell-text">Flavor check: Try Cool Mint?</div>
            <button class="cross-sell-btn" id="cross-add-mint">Add +1</button>
        `;
        container.appendChild(crossSellDiv);
        
        setTimeout(() => {
            document.getElementById('cross-add-mint').addEventListener('click', () => {
                const btn = document.querySelector('button[data-variant="Mint"]');
                if(btn) btn.click();
            });
        }, 0);
      }

      // --- DISCOUNT NOTE ---
      const note = document.createElement('div');
      note.className = 'discount-note';
      note.innerHTML = "Launch discount (20% off) applied at next step.";
      container.appendChild(note);

      // Update Totals
      document.getElementById('cart-count').textContent = count;
      document.getElementById('cart-total').textContent = `${(total / 100).toFixed(2)} AED`;
      document.getElementById('checkout-button').disabled = false;
    }

    // Expose globally
    window.updateCart = updateCart;

    function saveCart() {
      localStorage.setItem('caffy_cart', JSON.stringify(cart));
    }

    function updateOrderSummary() {
      const orderItemsList = document.getElementById('order-items-list');
      orderItemsList.innerHTML = '';
      
      const priceData = calculateFinalTotal();

      // 1. List Items
      cart.forEach(item => {
        const itemTotal = item.price * item.quantity;
        const orderItem = document.createElement('div');
        orderItem.classList.add('order-item');
        orderItem.innerHTML = `
          <span class="order-item-name">${item.name} × ${item.quantity}</span>
          <span class="order-item-price">${(itemTotal / 100).toFixed(2)} AED</span>
        `;
        orderItemsList.appendChild(orderItem);
      });

      // 2. Show Discount (From Worker Rules)
      if (priceData.discountAmount > 0) {
        const discountItem = document.createElement('div');
        discountItem.classList.add('order-item');
        discountItem.style.color = '#00ffff'; 
        discountItem.innerHTML = `
          <span class="order-item-name">${priceData.discountLabel}</span>
          <span class="order-item-price">-${(priceData.discountAmount / 100).toFixed(2)} AED</span>
        `;
        orderItemsList.appendChild(discountItem);
      }
      
      // 3. Update Total Row
      const totalItem = document.createElement('div');
      totalItem.classList.add('order-item');
      totalItem.style.borderTop = '1px solid #333'; 
      totalItem.style.marginTop = '10px';
      totalItem.style.paddingTop = '10px';
      totalItem.style.fontWeight = 'bold';
      totalItem.innerHTML = `
        <span>Total</span>
        <span style="color: #00ffff; font-size: 1.2em;">${(priceData.finalTotal / 100).toFixed(2)} AED</span>
      `;
      orderItemsList.appendChild(totalItem);

      // 4. Update the Button
      const submitBtn = document.getElementById('submit-payment-button');
      if(submitBtn) {
          submitBtn.querySelector('#button-text').textContent = `Pay ${(priceData.finalTotal / 100).toFixed(2)} AED`;
      }
    }

    // --- VIEW MANAGEMENT FUNCTIONS ---

    // 1. OPEN THE CART
    function openCart(immediate = false) {
      if (immediate) cartModal.classList.add('no-transition');
      
      cartModal.classList.add('open');
      document.body.classList.add('cart-open');
      
      if (immediate) {
        void cartModal.offsetWidth; // Force browser update
        cartModal.classList.remove('no-transition');
      }
      
      // Update browser history so "Back" works
      if (history.state?.view !== 'cart') {
        history.pushState({ view: 'cart' }, '');
      }
    }

    // 2. CLOSE THE CART
    function closeCart() { 
      cartModal.classList.remove('open'); 
      document.body.classList.remove('cart-open'); 
    }

    // 3. SHOW CHECKOUT
    function showCheckoutView() { 
      document.body.classList.add('checkout-active'); 
      mainContent.classList.add('hidden'); 
      checkoutView.classList.remove('hidden');
      updateOrderSummary();

      // Update browser history so "Back" works
      if (history.state?.view !== 'checkout') {
        history.pushState({ view: 'checkout' }, '');
      }
    }

    // 4. HIDE CHECKOUT
    function hideCheckoutView() { 
      document.body.classList.remove('checkout-active'); 
      mainContent.classList.remove('hidden'); 
      checkoutView.classList.add('hidden'); 
    }

    // --- INITIATE CHECKOUT ---
    async function initiateCheckout() {
      if (cart.length === 0) return;

      // --- NEW: CAPTURE UTM & CONSENT DATA ---
      const urlParams = new URLSearchParams(window.location.search);
      const utm_source = urlParams.get('utm_source') || 'direct';
      const utm_campaign = urlParams.get('utm_campaign') || 'none';
      const landing_page = window.location.pathname;
      // Capture marketing checkbox state (it's checked by default in your HTML)
      const marketingConsent = document.getElementById('marketing-checkbox').checked ? 'opt_in' : 'opt_out';
      // --- END NEW DATA ---

      // --- UMAMI TRACKING START ---
      const totalVal = (cart.reduce((t, i) => t + i.price * i.quantity, 0) / 100).toFixed(2);
      const totalCount = cart.reduce((t, i) => t + i.quantity, 0);
      const flavorList = cart.map(i => `${i.name} (x${i.quantity})`).join(', '); // Using .name for n8n readability
      if (typeof umami !== 'undefined') {
        umami.track('View Checkout Form', { 
            value: totalVal, 
            items: totalCount, 
            contents: flavorList 
        });
      }
      // --- UMAMI TRACKING END ---

      closeCart();
      showCheckoutView();

      //const totalAmount = (cart.reduce((t, i) => t + i.price * i.quantity, 0) / 100).toFixed(2);
      //document.getElementById('submit-payment-button').querySelector('#button-text').textContent = `Pay ${totalAmount} AED`;

      try {
        // 1. GET THE UMAMI SESSION ID (Using the robust helper)
        const umamiSessionId = await getUmamiId();

        // 2. PREPARE THE PAYLOAD WITH ALL DATA
        const secure_line_items = cart.map(item => ({ id: item.id, quantity: item.quantity }));
        const bodyPayload = {
          line_items: secure_line_items,
          metadata: {
            // --- ADDED THESE TO YOUR METADATA ---
            utm_source: utm_source,
            utm_campaign: utm_campaign,
            landing_page: landing_page,
            marketing_consent: marketingConsent,
            items_summary: flavorList,
            umami_session_id: umamiSessionId
          }
        };

        // 3. SEND THE ENHANCED PAYLOAD TO YOUR WORKER
        const response = await fetch('https://caffy-stripe-cloud.imran-aziz.workers.dev', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(bodyPayload),
        });
        
        const data = await response.json();
        if (!response.ok) throw new Error(data.error?.message || 'Server error');

        const clientSecret = data.clientSecret;
        const appearance = { 
          theme: 'night', 
          variables: { 
            colorPrimary: '#00ffff', 
            colorBackground: '#1a1a1a', 
            colorText: '#ffffff', 
            colorDanger: '#ff5a5f', 
            fontFamily: 'Montserrat, sans-serif',
            borderRadius: '4px',
            spacingUnit: '6px'
          } 
        };
        elements = stripe.elements({ appearance, clientSecret });

        // Address and Payment element mounting
        addressElement = elements.create("address", {
          mode: "shipping",
          allowedCountries: ['AE'],
          blockPoBox: true,
          fields: { phone: 'always' },
          validation: { phone: { required: 'always' } },
        });
        addressElement.mount("#address-element");

        paymentElement = elements.create("payment");
        paymentElement.mount("#payment-element");

      } catch (error) {
        console.error('Checkout Init Error:', error);
        alert('Could not initiate checkout. Please try again.');
        hideCheckoutView();
      }
    }

    document.getElementById('payment-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      setLoading(true);

      // --- UMAMI TRACKING START ---
      if (typeof umami !== 'undefined') {
        umami.track('Submit Payment');
      }
      // --- UMAMI TRACKING END ---
      
      // Collect customer data
      const email = document.getElementById('customer-email').value;
      const marketingConsent = document.getElementById('marketing-checkbox').checked;
      
      const { error } = await stripe.confirmPayment({
        elements,
        confirmParams: {
          return_url: `${window.location.protocol}//${window.location.host}/checkout/return.html?marketing_consent=${marketingConsent}`,
          payment_method_data: {
            billing_details: {
              email: email,
            },
          },
          receipt_email: email,
        },
      });

      
      if (error) {
        // --- UMAMI TRACKING START ---
        if (typeof umami !== 'undefined') {
          umami.track('Payment Failed', { 
            reason: error.message, 
            code: error.code 
          });
        }
        // --- UMAMI TRACKING END ---

        if (error.type === "card_error" || error.type === "validation_error") {
          showMessage(error.message);
        } else {
          showMessage("An unexpected error occurred.");
        }
      }
      setLoading(false);
    });

    // --- HELPER FUNCTIONS FOR PAYMENT FORM ---
    function setLoading(isLoading) {
      const btn = document.getElementById('submit-payment-button');
      if (isLoading) {
        btn.disabled = true;
        btn.querySelector('#button-text').textContent = "Processing...";
      } else {
        btn.disabled = false;
        const priceData = calculateFinalTotal();
        btn.querySelector('#button-text').textContent = `Pay ${(priceData.finalTotal / 100).toFixed(2)} AED`;
      }
    }
    
    function showMessage(messageText) {
      const messageContainer = document.getElementById('payment-message');
      messageContainer.classList.remove("hidden");
      messageContainer.textContent = messageText;
      setTimeout(() => { messageContainer.classList.add("hidden"); }, 4000);
    }

    // --- FORM ENHANCEMENTS ---
    // (Note: Removed manual phone formatting as Stripe Elements handles it)

    // Real-time email validation
    function validateEmail(email) {
      const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return re.test(email);
    }

    // --- BACK BUTTON LOGIC ---
    window.addEventListener('popstate', (event) => {
      const view = event.state?.view;

      if (view === 'checkout') {
        showCheckoutView();
      } 
      else if (view === 'cart') {
        hideCheckoutView(); // In case we were in checkout
        openCart(true);     // Snap cart open instantly
      } 
      else {
        // No state means we are back at the main store
        hideCheckoutView();
        closeCart();
      }
    });

    // --- EVENT LISTENERS ---
    document.addEventListener('DOMContentLoaded', () => {
      history.replaceState({ view: 'store' }, '');
      // Product add to cart buttons
      document.querySelectorAll('.add-to-cart-button').forEach(button => {
        button.addEventListener('click', e => {
          addToCart({ ...e.currentTarget.dataset, price: parseInt(e.currentTarget.dataset.price) });
          openCart();
          document.body.classList.add('cart-open');
        });
      });

      // Cart item actions
      cartItemsContainer.addEventListener('click', e => {
        const { id, action } = e.target.dataset;
        if (!id) return;
        const item = cart.find(i => i.id === id);
        if (!item) return;
        
        if (e.target.classList.contains('remove-item-btn')) {
          // --- UMAMI TRACKING START ---
          if (typeof umami !== 'undefined') {
            umami.track('Remove from Cart', { name: item.name });
          }
          // --- UMAMI TRACKING END ---
          updateCart(id, 0);
        }
        else if (action === 'decrease') updateCart(id, item.quantity - 1);
        else if (action === 'increase') updateCart(id, item.quantity + 1);
      });

      // Cart and checkout navigation
      cartIcon.addEventListener('click', () => {
        openCart();
      });
      closeCartButton.addEventListener('click', () => {
        if (history.state?.view === 'cart') {
          history.back();
        } else {
          closeCart();
        }
      });
      checkoutButton.addEventListener('click', () => {
        // Just hide the cart UI, don't go back in history yet
        cartModal.classList.remove('open'); 
        document.body.classList.remove('cart-open');
        initiateCheckout(); 
      });
      backToStoreButton.addEventListener('click', () => {
        history.back(); // This will trigger the logic to show the Cart instantly
      });

      // Footer toggle
      footerButton.addEventListener('click', (event) => {
        event.stopPropagation();
        footer.style.display = footer.style.display === 'none' ? 'flex' : 'none';
      });
      document.addEventListener('click', (event) => {
        if (footer.style.display === 'flex' && !footer.contains(event.target) && !footerButton.contains(event.target)) {
          footer.style.display = 'none';
        }
      });

      // Form field enhancements
      const emailField = document.getElementById('customer-email');
      
      // Email validation
      emailField.addEventListener('blur', (e) => {
        const email = e.target.value;
        if (email && !validateEmail(email)) {
          e.target.style.borderColor = '#ff5a5f';
        } else {
          e.target.style.borderColor = '#444';
        }
      });

      // Terms checkbox requirement
      const termsCheckbox = document.getElementById('terms-checkbox');
      const submitButton = document.getElementById('submit-payment-button');
      
      function updateSubmitButton() {
        // Note: We'll also check other validations in the form submit handler
        // This is just for the terms checkbox visual feedback
        if (!termsCheckbox.checked) {
          submitButton.style.opacity = '0.6';
        } else {
          submitButton.style.opacity = '1';
        }
      }
      
      termsCheckbox.addEventListener('change', updateSubmitButton);
      updateSubmitButton(); // Initial state

      // Initialize
      footer.style.display = 'none';
      updateCartDisplay();
    });

    // ============================================================
    // PRODUCTION FEATURES: Live Pricing & Ghost Cart
    // ============================================================

    async function initLiveFeatures() {
      // 1. LIVE PRICE FETCHING
      // This ensures the price on the button matches the price in Stripe
      try {
        const response = await fetch('https://caffy-stripe-cloud.imran-aziz.workers.dev/get-prices');
        if (response.ok) {
          const data = await response.json(); // Get the whole object
          const prices = data.prices;         // Extract prices
          
          // STORE THE RULES
          activeDiscountRules = data.discounts || []; // Extract discounts
          
          // IDs from your Worker
          const mintId = "price_1QrjjHFAY8BwNpdGLqU1zwtO";
          const berryId = "price_1QrjbYFAY8BwNpdG1KvCMlKz";

          // Update Display Text
          if (prices[mintId]) {
            document.getElementById('price-text-mint').textContent = (prices[mintId] / 100).toFixed(2) + " AED";
          }
          if (prices[berryId]) {
            document.getElementById('price-text-blueberry').textContent = (prices[berryId] / 100).toFixed(2) + " AED";
          }

          // Update Buttons (Critical for Cart Math)
          document.querySelectorAll('.add-to-cart-button').forEach(btn => {
            const id = btn.dataset.id;
            if (prices[id]) {
              btn.dataset.price = prices[id]; // Set the real price (e.g. 5000)
            }
          });
        }
      } catch (e) {
        console.warn("Pricing fetch failed, using fallbacks.", e);
        // Fallback in case Worker is down
        document.getElementById('price-text-mint').textContent = "50.00 AED";
        document.getElementById('price-text-blueberry').textContent = "50.00 AED";
        // Manually set fallbacks for buttons if fetch fails
        document.querySelector('[data-variant="Mint"]').dataset.price = "5000";
        document.querySelector('[data-variant="Blueberry"]').dataset.price = "5000";
      }

      // 2. GHOST CART (Abandoned Checkout)
      // Captures email the moment they click away from the email field
      const emailInput = document.getElementById('customer-email');
      if (emailInput) {
        emailInput.addEventListener('blur', (e) => {
          const email = e.target.value;
          // Only send if email is valid and user has items in cart
          if (email.includes('@') && email.includes('.') && cart.length > 0) {
            fetch('https://caffy-stripe-cloud.imran-aziz.workers.dev/capture-lead', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              keepalive: true, // Ensures request finishes even if page closes
              body: JSON.stringify({
                email: email,
                cart: cart,
                url: window.location.href
              })
            });
          }
        });
      }

      // --- EASTER EGG: SYSTEM DECRYPT (Subtle) ---
      document.querySelectorAll('.product-model').forEach(model => {
          let taps = 0;
          let resetTimer;

          model.addEventListener('pointerup', (e) => {
              taps++;
              clearTimeout(resetTimer);
              resetTimer = setTimeout(() => taps = 0, 2000);

              if(taps === 5) {
                  const container = model.parentElement;
                  const title = container.querySelector('h4.product');
                  const priceText = container.querySelector('p.price');
                  
                  // Save state
                  const originalTitle = title.getAttribute('data-original') || title.textContent;
                  const originalPrice = priceText.textContent;
                  if(!title.getAttribute('data-original')) title.setAttribute('data-original', originalTitle);

                  // 1. FADE OUT
                  title.style.transition = 'opacity 0.2s ease';
                  priceText.style.transition = 'opacity 0.2s ease';
                  title.style.opacity = 0;
                  priceText.style.opacity = 0;

                  setTimeout(() => {
                      // 2. SWAP & ACTIVATE "SYSTEM BOOT"
                      title.textContent = "Like what you see?";
                      title.classList.add('cyber-reveal');
                      title.style.opacity = 1;

                      // 3. SHOW DEAL (Clean text)
                      priceText.innerHTML = `You'll love the flavor even more`;
                      priceText.classList.add('deal-text');
                      
                      // Force a reflow before adding the visible class for transition to work
                      void priceText.offsetWidth; 
                      priceText.classList.add('visible');
                      priceText.style.opacity = 1;
                  }, 200);

                  // 4. RESET (5 Seconds)
                  setTimeout(() => {
                      title.style.opacity = 0;
                      priceText.style.opacity = 0;

                      setTimeout(() => {
                          // Restore Text
                          title.textContent = originalTitle;
                          title.classList.remove('cyber-reveal');
                          
                          priceText.textContent = originalPrice;
                          priceText.classList.remove('deal-text', 'visible');
                          
                          title.style.opacity = 1;
                          priceText.style.opacity = 1;
                          
                          initLiveFeatures(); // Ensure price accuracy
                      }, 200);
                  }, 5000);

                  taps = 0;
              }
          });
      });

       // --- NEW: SEO LANDING PAGE HANDSHAKE ---
      // This must run AFTER the prices are fetched so we have the real Price IDs
      const urlParams = new URLSearchParams(window.location.search);
      const itemToAdd = urlParams.get('add');

      if (itemToAdd) {
        const variantName = itemToAdd === 'mint' ? 'Mint' : 'Blueberry';
        const targetBtn = document.querySelector(`button[data-variant="${variantName}"]`);

        if (targetBtn) {
          // 1. Clear any old cart data (optional, but cleaner for direct buy)
          cart = []; 
          
          // 2. Add the specific item
          addToCart({ ...targetBtn.dataset, price: parseInt(targetBtn.dataset.price) });
          
          // 3. Immediately trigger the checkout process
          initiateCheckout();
          
          // 4. Clean the URL so a refresh doesn't trigger it again
          window.history.replaceState({}, document.title, window.location.pathname);
        }
      }

    }

    // Run this when page loads
    document.addEventListener('DOMContentLoaded', initLiveFeatures);

  </script>
</body>

</html>