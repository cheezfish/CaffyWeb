<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caffy Checkout</title>
    <link rel="stylesheet" href="../css/normalize.css">
    <link rel="stylesheet" href="../css/skeleton.css">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="icon" type="image/png" href="../images/favicon.ico">
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&family=Ubuntu+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'"/>
    <noscript>
      <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&family=Ubuntu+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet" type="text/css"/>
    </noscript>
    <script src="https://js.stripe.com/v3/"></script>

    <!-- Basic styling for the new cart elements -->
    <style>
        .cart-icon-container { position: fixed; bottom: 20px; right: 20px; cursor: pointer; z-index: 999; }
        #cart-icon-container img { width: 60px; height: 60px; }
        #cart-count { position: absolute; top: -5px; right: -5px; background: #ff5a5f; color: white; border-radius: 50%; padding: 2px 8px; font-size: 14px; font-weight: bold; }
        .cart-modal { position: fixed; top: 0; right: 0; width: 350px; height: 100%; background: white; box-shadow: -5px 0 15px rgba(0,0,0,0.15); z-index: 1000; transform: translateX(100%); transition: transform 0.3s ease-in-out; display: flex; flex-direction: column; padding: 20px; }
        .cart-modal.open { transform: translateX(0); }
        .cart-header { font-size: 24px; font-weight: bold; margin-bottom: 20px; }
        .cart-items { flex-grow: 1; overflow-y: auto; }
        .cart-item { display: flex; align-items: center; margin-bottom: 15px; }
        .cart-item img { width: 60px; height: 60px; margin-right: 15px; }
        .cart-item-info { flex-grow: 1; }
        .cart-item-info h5 { margin: 0; font-size: 16px; }
        .cart-item-info p { margin: 5px 0 0; }
        .cart-footer { padding-top: 20px; border-top: 1px solid #eee; }
        .cart-total { display: flex; justify-content: space-between; font-size: 18px; font-weight: bold; margin-bottom: 20px; }
        #checkout-button { width: 100%; }
        .hidden { display: none !important; }
    </style>
</head>

<body>
  <!-- This div will wrap all page content that should hide during checkout -->
  <div id="main-content">
    <div class="container" id="HeroContainer">
      <div class="hero twelve columns" onclick="window.location.href='https://getcaffy.com/';" style="cursor: pointer; z-index:0;">
          <div id="title" class="montserrat-500">CAFFY</div>
          <h5 id="subtitle" class="montserrat-300">Welcome to the future - you belong here.</h5>
      </div>
    </div>

    <div class="container" style="margin-bottom: 100px;">
        <div class="row">
            <div class="six columns u-text-center">
                <img class="productimage" src="../images/caffy-pouch-mint.png" alt="Caffy Pouch - Cool Mint" style="width:100%">
                <h4 class="product">Cool Mint</h4>
                <p class="price">50 AED</p>
                <!-- ADD TO CART BUTTONS with data attributes -->
                <button class="button-primary add-to-cart-button six columns offset-by-three"
                    data-id="caffy-mint"
                    data-name="Caffy Pouch - Cool Mint"
                    data-price="5000"
                    data-image="../images/caffy-pouch-mint.png">
                    Add to Cart
                </button>
            </div>
            <div class="six columns u-text-center">
                <img class="productimage" src="../images/caffy-pouch-blueberry.png" alt="Caffy Pouch - Blueberry" style="width:100%">
                <h4 class="product">Blueberry</h4>
                <p class="price">50 AED</p>
                <button class="button-blueberry add-to-cart-button six columns offset-by-three"
                    data-id="caffy-blueberry"
                    data-name="Caffy Pouch - Blueberry"
                    data-price="5000"
                    data-image="../images/caffy-pouch-blueberry.png">
                    Add to Cart
                </button>
            </div>
        </div>
    </div>

    <div class="container" id="FooterContainer">
      <!-- Your Footer HTML... -->
    </div>
  </div>

  <!-- DIV for the Stripe Embedded Component to mount into -->
  <div id="stripe-checkout" class="container"></div>

  <!-- Cart Icon -->
  <div class="cart-icon-container" id="cart-icon">
    <img src="../images/cart.png" alt="Shopping Cart">
    <span id="cart-count">0</span>
  </div>

  <!-- Cart Modal (hidden by default) -->
  <div class="cart-modal" id="cart-modal">
    <h3 class="cart-header">Your Basket</h3>
    <div class="cart-items" id="cart-items-container">
      <!-- Cart items will be dynamically inserted here -->
    </div>
    <div class="cart-footer">
      <div class="cart-total">
        <span>Total</span>
        <span id="cart-total">0 AED</span>
      </div>
      <button class="button-primary" id="checkout-button">Proceed to Checkout</button>
    </div>
  </div>

  <script type="text/javascript">
    // --- ACTION ITEM 1: Replace with your Stripe PUBLISHABLE key ---
    const stripe = Stripe('pk_live_51QYtamFAY8BwNpdGBzHG1vdjlqsfJ0dSBT2kTgLfEhFP3oYhdiPboMjaIAmgiXBWKt0OqvIM4xrMmydKBRNkpOny00qMCEFQaX');

    // --- Cart State & DOM Elements ---
    let cart = [];
    const cartIcon = document.getElementById('cart-icon');
    const cartModal = document.getElementById('cart-modal');
    const cartItemsContainer = document.getElementById('cart-items-container');
    const cartCount = document.getElementById('cart-count');
    const cartTotal = document.getElementById('cart-total');
    const checkoutButton = document.getElementById('checkout-button');
    const mainContent = document.getElementById('main-content');
    const stripeCheckoutContainer = document.getElementById('stripe-checkout');

    // --- Cart Logic ---
    function addToCart(item) {
      const existingItem = cart.find(cartItem => cartItem.id === item.id);
      if (existingItem) {
        existingItem.quantity++;
      } else {
        cart.push({ ...item, quantity: 1 });
      }
      updateCartDisplay();
    }

    function updateCartDisplay() {
      // Clear previous items
      cartItemsContainer.innerHTML = '';
      let total = 0;
      let count = 0;

      cart.forEach(item => {
        total += item.price * item.quantity;
        count += item.quantity;
        
        const itemElement = document.createElement('div');
        itemElement.classList.add('cart-item');
        itemElement.innerHTML = `
          <img src="${item.image}" alt="${item.name}">
          <div class="cart-item-info">
            <h5>${item.name}</h5>
            <p>${item.quantity} x ${(item.price / 100).toFixed(2)} AED</p>
          </div>
        `;
        cartItemsContainer.appendChild(itemElement);
      });

      cartCount.textContent = count;
      cartTotal.textContent = `${(total / 100).toFixed(2)} AED`;
    }

    // --- Checkout Logic ---
    async function initiateCheckout() {
      if (cart.length === 0) {
        alert("Your basket is empty.");
        return;
      }
      
      // 1. Hide page content and show a loading state
      mainContent.classList.add('hidden');
      cartModal.classList.remove('open');
      stripeCheckoutContainer.innerHTML = '<h4>Loading Checkout...</h4>';

      // 2. Format cart data for the Stripe API
      const line_items = cart.map(item => {
        return {
          price_data: {
            currency: 'aed',
            product_data: {
              name: item.name,
              images: [window.location.origin + item.image.replace('..', '')]
            },
            unit_amount: item.price,
          },
          quantity: item.quantity,
        };
      });

      // 3. Call your backend to create the Checkout Session
      try {
        // --- ACTION ITEM 2: Replace with your Cloudflare Worker URL ---
        const response = await fetch('https://caffy-stripe-cloud.imran-aziz.workers.dev', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ line_items }),
        });
        
        const data = await response.json();
        if (data.error) throw new Error(data.error.message);

        // 4. Initialize and mount the Embedded Checkout
        const checkout = await stripe.initEmbeddedCheckout({
          clientSecret: data.clientSecret,
        });
        stripeCheckoutContainer.innerHTML = ''; // Clear loading message
        checkout.mount('#stripe-checkout');

      } catch(error) {
        console.error('Checkout Error:', error);
        alert('Could not initiate checkout. Please try again.');
        mainContent.classList.remove('hidden'); // Show content again on error
      }
    }

    // --- Event Listeners ---
    document.querySelectorAll('.add-to-cart-button').forEach(button => {
      button.addEventListener('click', (e) => {
        const item = e.target.dataset;
        addToCart({
          id: item.id,
          name: item.name,
          price: parseInt(item.price),
          image: item.image
        });
        cartModal.classList.add('open'); // Open cart when item is added
      });
    });

    cartIcon.addEventListener('click', () => cartModal.classList.toggle('open'));
    checkoutButton.addEventListener('click', initiateCheckout);

  </script>
  <script src="../script.js" defer></script>
  <script src="https://kit.fontawesome.com/ab45b5ded8.js" crossorigin="anonymous"></script>
</body>
</html>